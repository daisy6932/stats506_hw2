---
title: "Daixi Huang_stats506_hw3"
format: html
editor: visual
---

#Prob 1
```{r}
# If they are SAS XPT files
library(haven); library(readr); library(dplyr); library(stringr)
library(tidyr); library(broom); library(pscl); library(kableExtra)
library(stargazer); library(sjlabelled); library(emmeans); library(car)
library(ggplot2)

AUX_I <- read_xpt("AUX_I.XPT")
DEMO_I <- read_xpt("DEMO_I.XPT")

data <- read_xpt("AUX_I.XPT")
data <- read_xpt("DEMO_I.XPT")
#check variable names and documentation
str(AUX_I)
str(DEMO_I)
#merge
merged <- inner_join(AUX_I, DEMO_I, by = "SEQN")
dim(merged)
```


```{r}
# 
data <- merged %>%
  transmute(
    SEQN,
    gender = factor(RIAGENDR, levels = c(1, 2), labels = c("Male", "Female")),
    citizen = factor(DMDCITZN, levels = c(1, 2), labels = c("Citizen", "Non-citizen")),
    n_child = DMDHHSZA,
    income = as.numeric(INDHHIN2),   # 转为连续
    tymp_R = AUXTWIDR,
    tymp_L = AUXTWIDL
  )

# clear missing values
data[data == 7 | data == 9 | data == 77 | data == 99] <- NA

# 
data <- na.omit(data)

dim(data)
summary(data)

```

```{r}
#Poisson
m1R <- glm(tymp_R ~ gender, data = data, family = poisson)
m2R <- glm(tymp_R ~ gender + citizen + n_child + income, data = data, family = poisson)
m1L <- glm(tymp_L ~ gender, data = data, family = poisson)
m2L <- glm(tymp_L ~ gender + citizen + n_child + income, data = data, family = poisson)

```


```{r}
#Incidence Rate Ratios, sample, pseudo-R^2, AIC
library(broom)
library(knitr)
library(stargazer)

get_model_summary <- function(model) {
  coefs <- exp(coef(model))                      # IRR
  ci <- exp(confint(model))                      # 置信区间
  r2 <- 1 - model$deviance / model$null.deviance # pseudo-R²
  data.frame(
    term = names(coefs),
    IRR = round(coefs, 3),
    CI_low = round(ci[,1], 3),
    CI_high = round(ci[,2], 3),
    AIC = round(AIC(model), 1),
    R2 = round(r2, 3),
    N = nobs(model)
  )
}

tab1R <- get_model_summary(m1R)
tab2R <- get_model_summary(m2R)
tab1L <- get_model_summary(m1L)
tab2L <- get_model_summary(m2L)

kable(tab2L, caption = "Model 2L: Poisson Regression (Left Ear) – IRRs and Model Stats")

```
#(a)
```{r}
# Get gender IRR and CI for model 2L
summary(m2L)
exp(coef(m2L))

```
#(b)
```{r}
newdata <- data.frame(
  gender = c("Male", "Female"),
  citizen = "Citizen",
  n_child = mean(data$n_child, na.rm = TRUE),
  income = mean(data$income, na.rm = TRUE)
)

pred <- predict(m2L, newdata, type = "response", se.fit = TRUE)
pred_df <- data.frame(newdata, fit = pred$fit, se = pred$se.fit)
pred_df

pred_df <- pred_df %>%
  mutate(
    lower = fit - 1.96 * se,
    upper = fit + 1.96 * se
  )

pred <- predict(m2L, newdata, type = "link", se.fit = TRUE)


diff_est <- pred$fit[2] - pred$fit[1]
diff_se <- sqrt(sum(pred$se.fit^2))

#  z and p 
z_value <- diff_est / diff_se
p_value <- 2 * (1 - pnorm(abs(z_value)))

data.frame(
  difference_on_link_scale = diff_est,
  z = z_value,
  p = p_value,
  significant = p_value < 0.05
)
```

Interpretation of Gender Effect in Model 2L (Left ear Poisson regression)

The incidence rate ratio (IRR) for the "genderFemale" variable is 1.025, with a 95% confidence interval [1.017, 1.033] and a p-value < 0.001. This means that, holding citizenship status, number of young children, and household income constant, females have on average a 2.5% higher expected tympanometric width in the left ear compared to males.

The result is statistically significant (z = 6.07, p = 1.29e-09).
The difference on the link (log) scale is 0.0245 (also highly significant).

However, the effect size is small: although statistically significant due to the large sample size (N = 2945), the practical difference between males and females is minor.

In summary: 
There is strong evidence of a difference in tympanometric width between men and women (p < 0.001), but the predicted value for females is only slightly higher than for males.

#Prob2
```{r}
library(DBI)
library(RSQLite)
library(dplyr)
library(microbenchmark)

con <- dbConnect(RSQLite::SQLite(), "sakila_master.db")
dbListTables(con)
```